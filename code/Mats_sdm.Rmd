---
title: "Mat_sdm"
author: "Khum"
date: "2022-10-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Folders were created to store the original data and derived data products from analysis

```{r}
# dir.create("../code")
# dir.create("../data")
# dir.create("../data_output")
# dir.create("../figures)
```


# required libraries were loaded here

```{r}
# loading libraries
library(raster)
library(dplyr)
library(rgdal)
library(sf)
library(ggplot2)
library(readxl)
library(dplyr)

```

## working in black mats raster layer to get presence and absence dta
# we decided (discussion with Eric) to use following cut off point
# abundance values great er than 5% (0.05) as presence point
# then mask it by elevation if there is any disturbed signatures 

# abundances values less than 1% (0.001) or even 0.4$(0.0004)as pint for
# absence piont

# Value between 1% and 5% as NA for the modeling
## new projetion with dta fram but they reduce the number of rows in dataframe
## working in masked area from lake fryxell
## source of conveting data frame of utm to degree decimals

https://stackoverflow.com/questions/60068012/converting-northing-easting-into-decimal-degrees-in-r

```{r}
# Lake Fryxell basin as AOI

fryxell_aoi <- read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/fryxell_basin_AOI_newupdated.shp")

# lake outline to remove from AOI
lake_outline <- read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/lake_fryxell_outline.shp")%>%
  st_transform(crs(fryxell_aoi))


# removing permanent lake regions from the analysis

fryxell_diff <-st_difference(fryxell_aoi,lake_outline) # it works even though it shows warning

#########################

# blackmat raster layers
blk_mat <- raster("C:/Users/Khum/Documents/mbm_updated_data/response/PERCENTAGE_black-mat.tif")



# masking layer making ready
fryxell_diff_msk<-fryxell_diff%>%
  st_transform(crs(blk_mat))

# now masked black mats layer
blk_mat_msk<-mask(blk_mat,fryxell_diff_msk)


##
writeRaster(blk_mat_msk,"C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/code/blackmat/proj_Current/individual_projections/diff_cal/blk_unmix.tiff")

## additional work for the analysis of the changes  in the prediction
## getting the total number of pixels for consideration

blk_mat_msk_ti<-blk_mat_msk>0.05

g<-as.data.frame(blk_mat_msk_ti,xy=TRUE)

# cellStats(blk_mat_msk_ti,'sum')


#########

# converting masked raster into data frame with coordiantes and pizxel values
blk.data<-as.data.frame(blk_mat_msk,xy=TRUE)%>%
  rename(longitude="x",
         latitude="y")%>%
  rename(layer="PERCENTAGE_black.mat")


## classification of pixel into presence and absence coordiantes
blk.data$cat <-
  cut(blk.data$layer,
      breaks=c(0,0.001,0.05,1),
      labels=c("Absent","NA","Present"))

# looking table of presence and absence points
table(blk.data$cat)

## converted the coordinates into sf objects
## This is doing just to make coordinates into degree decinams

library(sf)
blk.data_prj<-st_as_sf(blk.data,
                       coords=c("longitude","latitude"),
                       remove=FALSE,
                       crs=crs(blk_mat))

## this all the process is done to get right amount of gps
## point with xy coordinates in degree decimals.

blk.data.st<-st_transform(blk.data_prj, crs = "+proj=longlat +datum=WGS84")%>% 
  mutate(long_degrees = st_coordinates(.)[,1],
         lat_degrees = st_coordinates(.)[,2])


# presence data frame to thin separately
blk.data.st.df_presence<-as.data.frame(blk.data.st)%>%
  filter(cat %in% c("Present"))%>%
  mutate(species="mat")

# absence data frame to thin separately
blk.data.st.df_absence<-as.data.frame(blk.data.st)%>%
  filter(cat %in% c("Absent"))%>%
  mutate(species="mat")%>%
  slice_sample(n=30000) # 100 thousands points aretoo much


## lets to thinning
library(spThin)

thin_path<-("C:/Users/Khum/Documents/mbm_updated_data/thinned_data")

thin(blk.data.st.df_presence, lat.col="lat_degrees", long.col="long_degrees", spec.col="species", thin.par=0.02, reps=1, out.dir=thin_path, out.base="presence_mat_new")

thin(blk.data.st.df_absence, lat.col="lat_degrees", long.col="long_degrees", spec.col="species", thin.par=0.02, reps=1, out.dir=thin_path, out.base="absence_mat_mew")


presence.mat<-read.csv("C:/Users/Khum/Documents/mbm_updated_data/thinned_data/presence_mat_new_thin1.csv")%>%
  slice_sample(n=1000)%>%
  mutate(presence=1)


absence.mat<-read.csv("C:/Users/Khum/Documents/mbm_updated_data/thinned_data/absence_mat_mew_thin1.csv")%>%
  slice_sample(n=10000)%>%
  mutate(presence=0)

# final data ready for SDM analysis with 1 thousands presence
# 10t absence points

mat_pre_abs_new <-rbind(presence.mat,absence.mat)

write.csv(mat_pre_abs_new,
          "C:/Users/Khum/Documents/mbm_updated_data/thinned_data/mat_pre_abs_new.csv")

```

resample videos,
https://www.youtube.com/watch?v=63fL96wV4bU

## working fore predictor variables ready to do for the analysis

```{r}
library(dplyr)
library(sf)
library(raster)

list_pre <-list.files("C:/Users/Khum/Documents/mbm_updated_data/predictors", pattern=".tif$", full.names=TRUE)

ty<-read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")%>%
  st_transform(crs(raster(list_pre[2])))%>%
  st_zm()


# ty<- read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/fryxell_basin_update.shp")%>%
#   st_transform(crs(raster(list_pre[2])))

#########
gwc_masked<-mask(raster(list_pre[1]),ty)
snow_masked<-mask(raster(list_pre[2]),ty)
snow<-snow_masked
snow[is.na(snow[])]<-0

snow_0<-mask(snow,ty)

#writeRaster(snow_0,"C:/Users/Khum/Documents/mbm_updated_data/arcmap_test/snow_0.tif")


## testing if masked function worked
plot(gwc_masked)
plot(ty$geometry,add=TRUE)
##

dem<-raster("C:/Users/Khum/Documents/mbm_updated_data/predictors/Taylor_DEM.tif") 

ty1<- read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")%>%
  st_transform(crs(dem))%>%
  st_zm()

dem_masked<-mask(dem,ty1)
dem_proj<-projectRaster(dem_masked,snow_masked)

elevation<-resample(dem_proj,snow_masked,method="bilinear")
slope<-terrain(elevation,opt=c("slope"), unit="radians")
aspect<-terrain(elevation,opt=c("aspect"),unit="radians")


gwc<-resample(gwc_masked,snow_masked,method="bilinear")

pre_mat_updated<-stack(gwc,snow_0,elevation,slope,aspect)

alt<-raster("C:/Users/Khum/OneDrive - UCB-O365/MBM_sdm_data/ex_rs_projection/IND_msk_alt.gri")

mat_env_05g_0<-projectRaster(pre_mat_updated,crs=crs(alt))


# writeRaster(mat_env_05g_0,"C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g_0.tif",format="GTiff")

pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g_0.tif")


# pre<-raster::stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env.grd")

# png("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/mat_predictor.png",
#     width=6,height=4,units="in",res=500)
# plot(pre)
# 
# dev.off()

```

## plots for the predictor variables
## but could not figure out making good continous color pattern

```{r}
library(raster)
pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g_0.tif")
names_pre<-c("Average_GCW", "Average_snow","Elevation","Slope","Aspect")
names(pre_env)<-names_pre


all_pre_df<-as.data.frame(pre_env, xy=TRUE)
library(tidyr)

all_pre_plong<-all_pre_df%>%
  tidyr::pivot_longer(col=c("Average_GCW", "Average_snow","Elevation","Slope","Aspect"), names_to="layer")
# ty<-read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")


Average_GWC<-all_pre_plong%>%
  filter(layer=="Average_GCW")%>%
  na.omit()%>%
  ggplot()+
      # geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=value))+
    # scale_fill_gradientn(colours=c("darkgreen","yellow","red"))+
    facet_wrap(~layer,scales="free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x = element_text(angle=92, vjust=1),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scale_x_continuous(breaks=c(163.00,163.10,163.20,163.30))+
  scale_y_continuous(breaks=c(-77.58,-77.62,-77.64,-77.66))

Average_GWC


Average_snow<-all_pre_plong%>%
  filter(layer=="Average_snow")%>%
  na.omit()%>%
  ggplot()+
      # geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=value))+
    scale_fill_gradientn(colours=c("white","yellow","darkgreen"))+
    facet_wrap(~layer,scales="free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x = element_text(angle=92, vjust=1),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scale_x_continuous(breaks=c(163.00,163.10,163.20,163.30))+
  scale_y_continuous(breaks=c(-77.58,-77.62,-77.64,-77.66))

Average_snow

Elevation<-all_pre_plong%>%
  filter(layer=="Elevation")%>%
  na.omit()%>%
  ggplot()+
      # geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=value))+
    scale_fill_gradientn(colours=c("white","yellow","darkgreen"))+
    facet_wrap(~layer,scales="free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x = element_text(angle=92, vjust=1),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scale_x_continuous(breaks=c(163.00,163.10,163.20,163.30))+
  scale_y_continuous(breaks=c(-77.58,-77.62,-77.64,-77.66))

Elevation

Slope<-all_pre_plong%>%
  filter(layer=="Slope")%>%
  na.omit()%>%
  ggplot()+
      # geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=value))+
    scale_fill_gradientn(colours=c("white","yellow","darkgreen"))+
    facet_wrap(~layer,scales="free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x = element_text(angle=92, vjust=1),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scale_x_continuous(breaks=c(163.00,163.10,163.20,163.30))+
  scale_y_continuous(breaks=c(-77.58,-77.62,-77.64,-77.66))

Slope

Aspect<-all_pre_plong%>%
  filter(layer=="Aspect")%>%
  na.omit()%>%
  ggplot()+
      # geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=value))+
    scale_fill_gradientn(colours=c("white","yellow","darkgreen"))+
    facet_wrap(~layer,scales="free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x = element_text(angle=92, vjust=1),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scale_x_continuous(breaks=c(163.00,163.10,163.20,163.30))+
  scale_y_continuous(breaks=c(-77.58,-77.62,-77.64,-77.66))

Aspect

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/blackmat_all_model.jpeg",
       width=9,height=9, units="in", dpi=500)

library(sf)
ty<-read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")


png("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/mat_predictor.png",
    width=8,height=5,units="in",res=500)

plot(pre_env,xlim=c(162.98,163.36),ylim=c(-77.66,-77.58),asp=NA,legend.mar=0)
plot(ty$geometry,add=TRUE, color="red")


dev.off()

png("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/mat_predictor_final.png",
    width=5,height=8,units="in",res=500)
par(mfrow=c(3,2))


plot(pre_env$Average_GCW,xlim=c(162.98,163.36),ylim=c(-77.66,-77.58),asp=NA)
plot(pre_env$Average_snow,xlim=c(162.98,163.36),ylim=c(-77.66,-77.58),asp=NA)
plot(pre_env$Elevation,xlim=c(162.98,163.36),ylim=c(-77.66,-77.58),asp=NA)
plot(pre_env$Slope,xlim=c(162.98,163.36),ylim=c(-77.66,-77.58),asp=NA)
plot(pre_env$Aspect,xlim=c(162.98,163.36),ylim=c(-77.66,-77.58),asp=NA)


dev.off()


```


## Starting here to build the models for final analysis

##############################################
##############################################
### lets model for black mats of 20 meter spatial distance with nearly 1t presence and 2t absence

## with blackmat probabilty of greater or equal to 05
# Now we have 1t of presence data and 10t of absence data
# Now the thinning is by the 20m distance

```{r}
library(raster)
pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g.tif")

# pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g_0.tif")


names_pre<-c("Average_GWC", "Average_snow","Elevation","Slope","Aspect")

names(pre_env)<-names_pre

pre_env1<-stack(pre_env$Slope,pre_env$Average_GWC,pre_env$Elevation,pre_env$Average_snow,pre_env$Aspect)

png("C:/Users/Khum/OneDrive - UCB-O365/Instaar/MANUSCRIPT/figures/mats_predictor_ms.png",
    width=8, height=5,res=500,unit=c("in"))
plot(pre_env1)

dev.off()
# 
#####################
blk_mat_pre_abs<-read.csv("C:/Users/Khum/Documents/mbm_updated_data/thinned_data/mat_pre_abs_new.csv")

# Select the name of the studied species
myRespName <- 'blackmat_gcw'

# Get corresponding presence/absence data
myResp <- as.numeric(blk_mat_pre_abs[, 'presence'])

# Get corresponding XY coordinates
myRespXY <- blk_mat_pre_abs[, c('long_degrees', 'lat_degrees')]


```

## To get the correlation matrix for the supplementary files

```{r}
########################
# extracting values and see the correaltions

library(dplyr)

blk<-read.csv("C:/Users/Khum/Documents/mbm_updated_data/thinned_data/mat_pre_abs_new.csv")%>%
  filter(presence==1)%>%
  rename(lattitude=lat_degrees,
         longitude=long_degrees)

pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g.tif")

# pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g_0.tif")


names_pre<-c("Average_GCW", "Average_snow","Elevation","Slope","Aspect")

names(pre_env)<-names_pre

presvals_all <- raster::extract(pre_env, blk[,c("longitude","lattitude")])


cor_mats<- presvals_all %>%
  na.omit()%>%
   cor()

write.csv(cor_mats, "C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/cor_mats.csv")

```


## Running the models

```{r}

# pre_env<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env_05g_0.tif")
# 
# 
# names_pre<-c("Average_GCW", "Average_snow","Elevation","Slope","Aspect")
# 
# names(pre_env)<-names_pre
# 
# library(raster)
# library(terra)

# pre<-stack("C:/Users/Khum/Documents/mbm_updated_data/predictors_update/mat_env.gri")
# # names(pre)<-c("SoilMoisture","Snow","Elevation","Slope","Aspect")

# https://github.com/biomodhub/biomod2/issues/143

library(biomod2)

myBiomodData <- BIOMOD_FormatingData(resp.var = myResp,
                                     expl.var = pre_env,
                                     resp.xy = myRespXY,
                                     resp.name = myRespName)


myBiomodData
#plot(myBiomodData)

# Create default modeling options
myBiomodOptions <- BIOMOD_ModelingOptions()
myBiomodOptions


# Model single models
myBiomodModelOut <- BIOMOD_Modeling(bm.format = myBiomodData,
                                    bm.options = myBiomodOptions,
                                    modeling.id = 'AllModels',
                                    nb.rep = 2,
                                    data.split.perc = 80,
                                    # data.split.table = myBiomodCV,
                                    var.import = 3,
                                    metric.eval = c('TSS','ROC'),
                                    do.full.models = FALSE)
                                    # seed.val = 123)
                                    # nb.cpu = 8)


myBiomodEM <- BIOMOD_EnsembleModeling(bm.mod = myBiomodModelOut,
models.chosen = 'all',
em.by = 'all',
metric.select = c('TSS'),
metric.select.thresh = c(0.5),
metric.eval = c('TSS', 'ROC'),
var.import = 1,
prob.mean = TRUE,
prob.median = FALSE,
prob.cv = FALSE,
prob.ci = FALSE,
prob.ci.alpha = 0.05,
committee.averaging = TRUE,
prob.mean.weight = FALSE,
prob.mean.weight.decay = 'proportional',
seed.val = 42)


# Project single models
myBiomodProj <- BIOMOD_Projection(bm.mod = myBiomodModelOut,
                                  proj.name = 'Current',
                                  new.env = pre_env,
                                  models.chosen = 'all',
                                  metric.binary = 'all',
                                  metric.filter = 'all',
                                  build.clamping.mask = TRUE)


# Project ensemble models (from single projections)
myBiomodEMProj <- BIOMOD_EnsembleForecasting(bm.em = myBiomodEM, 
                                             bm.proj = myBiomodProj,
                                             models.chosen = 'all',
                                             metric.binary = 'all',
                                             metric.filter = 'all')


```

```{r}
## I think we can select those models those have higheir
## either AUC value or 

## response curve
rescur_all<-bm_PlotResponseCurves(bm.out = myBiomodModelOut,
                      models.chosen = get_built_models(myBiomodModelOut)[c(1,2,3,4,5,6,7,8,9,10)],
                      fixed.var = 'mean',
                      colors=NA)

## yes it works

rescur_all<-rescur_all[[1]]
rescur_all_df<-as.data.frame(rescur_all)

write.csv(rescur_all_df,"C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/rescur_all_df.csv")


##

rescurve_all<-read.csv("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/rescur_all_df.csv")
library(dplyr)
library(ggplot2)

rescurve_all%>%
  mutate(expl.name=factor(expl.name,levels=c("Average_GCW","Average_snow","Elevation","Slope","Aspect")))%>%
  mutate(pred.name=factor(pred.name,levels=c("blackmat_AllData_RUN1_GBM","blackmat_AllData_RUN1_MAXENT.Phillips.2","blackmat_AllData_RUN1_MARS","blackmat_AllData_RUN1_GLM","blackmat_AllData_RUN1_ANN","blackmat_AllData_RUN1_FDA","blackmat_AllData_RUN1_GAM","blackmat_AllData_RUN1_CTA","blackmat_AllData_RUN1_RF","blackmat_AllData_RUN1_SRE")))%>%
  ggplot()+
  geom_line(aes(x=expl.val,y=pred.val, color=pred.name))+
  facet_wrap(~expl.name,scales = "free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        legend.title=element_blank(),
        legend.key=element_blank())+
  scale_color_manual(labels=c("GBM","MAXENT","MARS","GLM","ANN","FDA","GAM","CTA","RF","SRE"),
                       values=c("red","green","black","purple","blue","grey","orange","pink","violet", "yellow"))+
  labs(x="",y="")

library(ggplot2)

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/response_curve_all.jpg", width=8, height=5, dpi=500)

```


## getting response cureves of each predictor variables
https://github.com/biomodhub/biomod2/issues/154
# change the color
https://ggplot2.tidyverse.org/reference/scale_manual.html

```{r}
## I think we can select those models those have higheir
## either AUC value or 

## response curve
rescur<-bm_PlotResponseCurves(bm.out = myBiomodModelOut,
                      models.chosen = get_built_models(myBiomodModelOut)[c(2,10,8,1,5)],
                      fixed.var = 'mean',
                      colors=NA)

## yes it works

rescur_l<-rescur[[1]]
rescur_df<-as.data.frame(rescur_l)

write.csv(rescur_df,"C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/rescur_df.csv")


##

rescurve<-read.csv("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/rescur_df_ref.csv")
library(dplyr)
library(ggplot2)


rescurve%>%
  # mutate(tab.name=factor(tab.name,levels=c("GBM","MAXENT","MARS","GLM","ANN","FDA","GAM","CTA","RF","SRE")))%>%
  mutate(expl.name=factor(expl.name,levels=c("Soil moisture","Snow cover","Elevation","Slope","Aspect")))%>%
  ggplot()+
  geom_line(aes(x=expl.val,y=pred.val, color=pred.name))+
  facet_wrap(~expl.name,scales = "free")+
  theme(panel.background=element_rect(color="black",fill=NA),
        legend.title=element_blank(),
        legend.key=element_blank())+
  scale_color_manual(labels=c("GBM","MAXENT","MARS","BLM","ANN"),
                       values=c("red","green","black","purple","blue"))+
  labs(x="",y="")

library(ggplot2)

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/response_curve_new_wosnow.jpg", width=8, height=5, dpi=500)

```

## getting importance variables 

```{r}
################
get_value<-get_variables_importance(myBiomodModelOut, as.data.frame = TRUE)

write.csv(get_value,"C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/blackmat_imp_gwc.csv")

# library(dplyr)
var_imp<-read.csv("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/blackmat_imp_gwc.csv")

library(dplyr)
library(ggplot2)

var_imp_fig<-var_imp%>%
  group_by(Expl.var)%>%
  summarise(av=mean(Var.imp))%>%
  ggplot()+
  geom_bar(aes(x=reorder(Expl.var,-av),y=av*100), stat="identity", width=0.6)+
  labs(x="Predictor variables",y="% contribution")+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x=element_text(angle=90))

var_imp_fig

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/models_5g_new_gwc.png",
       width=3.5,height=3.5,dpi=500,units="in")
```

## getting the model values for the SDM modeling

```{r}

write.csv(bm_PlotEvalMean(bm.out=myBiomodModelOut)[1],file="C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/blackmat_evaluation.csv")

bm_PlotEvalMean(bm.out=myBiomodModelOut)[2]

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/model_blackmat_all_2round.png",
       width=6,height=4,dpi=500,units="in")

## new plots
mod_eva <-read.csv("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/data_output/blackmat_evaluation.csv")

mod_eva%>%
    mutate(tab.name=factor(tab.name,levels=c("GBM","MAXENT","MARS","GLM","ANN","FDA","GAM","CTA","RF","SRE")))%>%
ggplot(aes(x=tab.mean1,y=tab.mean2,color=tab.name))+
  geom_point()+
  geom_errorbar(aes(ymin=tab.mean2-tab.sd2,
                    ymax=tab.mean2+tab.sd2))+
  geom_errorbar(aes(xmin=tab.mean1-tab.sd1,
                   xmax=tab.mean1+tab.sd1))+
  geom_hline(yintercept=0.70, linetype="dotted")+
  scale_color_manual(values=c("red","green","black","purple","blue","grey","orange","pink","violet", "yellow"))+
  theme(panel.background=element_rect(color="black",fill=NA),
        legend.key=element_blank(),
        legend.title=element_blank())+
  labs(x="ROC",y="TSS")

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/BlackEvaluation_plot.jpeg",
       width=4.5,height=3.5, units="in", dpi=500)
```



https://gis.stackexchange.com/questions/237180/using-a-fixed-palette-range-to-plot-an-ndvi-raster-in-r#:~:text=library%20%28rasterVis%29%20%23%23%20A%20raster%20with%20values%20between,levelplot%20%28r%2C%20at%20%3D%20breaks%2C%20col.regions%20%3D%20cols%29

```{r}
all_raster<-


library(raster)
modpic<-stack("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/code/blackmat/proj_Current/proj_Current_blackmat.gri")

mod_all<-stack(modpic$blackmat_AllData_RUN1_GLM,
               modpic$blackmat_AllData_RUN1_GBM,
               modpic$blackmat_AllData_RUN1_GAM,
               modpic$blackmat_AllData_RUN1_CTA,
               modpic$blackmat_AllData_RUN1_ANN,
               modpic$blackmat_AllData_RUN1_SRE,
               modpic$blackmat_AllData_RUN1_FDA,
               modpic$blackmat_AllData_RUN1_MARS,
               modpic$blackmat_AllData_RUN1_RF,
               modpic$blackmat_AllData_RUN1_MAXENT.Phillips.2)

mod_names<-c("GLM","GBM","GAM","CTA","ANN","SRE","FDA","MARS","RF","MAXENT")

names(mod_all)<-mod_names


all_mod_df1<-as.data.frame(mod_all, xy=TRUE)

library(tidyr)

all_mod_plong1<-all_mod_df1%>%
  tidyr::pivot_longer(col=c("GLM","GBM", "GAM", "CTA", "ANN", "SRE", "FDA", "MARS", "RF", "MAXENT"), names_to="layer")%>%
  mutate(value=value/1000)

ty<-read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")

all_mod_plong1%>%
  na.omit()%>%
  ggplot()+
      geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=value))+
    scale_fill_gradientn(colours=c("darkgreen","yellow","red"))+
    facet_wrap(~layer, ncol=3)+
  theme(panel.background=element_rect(color="black",fill=NA),
        axis.text.x = element_text(angle=92, vjust=1),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scale_x_continuous(breaks=c(163.00,163.10,163.20,163.30))+
  scale_y_continuous(breaks=c(-77.58,-77.62,-77.64,-77.66))




ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/blackmat_all_model_final.jpeg",dpi=500)

ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/blackmat_all_model.jpeg",
       width=9,height=9, units="in", dpi=500)

```





```{r}

fryxell_aoi <- read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/fryxell_basin_AOI_newupdated.shp")

# lake outline to remove from AOI
lake_outline <- read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/lake_fryxell_outline.shp")%>%
  st_transform(crs(fryxell_aoi))


# removing permanent lake regions from the analysis

fryxell_diff <-st_difference(fryxell_aoi,lake_outline) # it works even though it shows warning

#########################

# blackmat raster layers
blk_mat <- raster("C:/Users/Khum/Documents/mbm_updated_data/response/PERCENTAGE_black-mat.tif")



# masking layer making ready
fryxell_diff_msk<-fryxell_diff%>%
  st_transform(crs(blk_mat))

# now masked black mats layer
blk_mat_msk<-mask(blk_mat,fryxell_diff_msk)



## additional work for the analysis of the changes  in the prediction
## getting the total number of pixels for consideration




## lets make 


mats_pro<-raster("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/code/blackmat/proj_Current/individual_projections/blackmat_EMmeanByTSS_mergedAlgo_mergedRun_mergedData.gri")

# masking 
# masking layer making ready
fryxell_diff_msk<-fryxell_diff%>%
  st_transform(crs(mats_pro))

## masking
mats_pro_mask<-mask(mats_pro, fryxell_diff_msk)

mats_pro_mask_tb <- mats_pro_mask>500

mats_pro_mask_tb[mats_pro_mask_tb==1] <- 2

## just making same resolution and projection

blk_mat_msk<-mask(blk_mat,fryxell_diff_msk)

blk_mat_msk_ti<-projectRaster(blk_mat_msk,mats_pro_mask_tb)


blk_mat_msk_ti_cat<-blk_mat_msk_ti>0.05

g<-as.data.frame(blk_mat_msk_ti_cat,xy=TRUE)

cellStats(blk_mat_msk_ti,'sum')




diff<- mats_pro_mask_tb-blk_mat_msk_ti_cat


diff.df<-as.data.frame(diff,xy=TRUE)%>%
  rename(longitude="x",
         latitude="y")

```









## Ensemble probability distribution
## removing box instead of degree
https://stackoverflow.com/questions/74940708/degree-symbol-in-plot-r-with-ggplot2-using-rstudio

```{r}
mats_pro<-raster("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/code/blackmat/proj_Current/individual_projections/blackmat_EMmeanByTSS_mergedAlgo_mergedRun_mergedData.gri")

# masking 
# masking layer making ready
fryxell_diff_msk<-fryxell_diff%>%
  st_transform(crs(mats_pro))

## masking
mats_pro_mask<-mask(mats_pro, fryxell_diff_msk)


## trying to get presece/ absence number of pixels
# lets do more work here,


mats_pro_tr<-projectRaster(mats_pro_mask,
                           crs=crs(blk_mat_msk_ti),
                           res=3.898757)

mats_pro_tr1<-resample(mats_pro_tr,blk_mat_msk_ti)

mats_pro_tb <- mats_pro_tr1>500

mats_pro_tb[mats_pro_tb==1] <- 2


cellStats(mats_pro_tb,'sum')


## working another direction for
blk_mat_msk_ti_f<-projectRaster(blk_mat_msk_ti,mats_pro_mask)

mats_pro_tb <- mats_pro_tr1>500

mats_pro_tb[mats_pro_tb==1] <- 2

## now looks the difference

diff<-mats_pro_tb-blk_mat_msk_ti

diff<-blk_mat_msk_ti_f-blk_mat_msk_ti

diff.df<-as.data.frame(diff,xy=TRUE)%>%
  rename(longitude="x",
         latitude="y")
  rename(layer="PERCENTAGE_black.mat")




######################

ty<-read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")%>%
  st_transform(crs(mats_pro))

mats_prob<-as.data.frame(mats_pro, xy=TRUE)
library(ggspatial)
library(mapmisc)
library(ggsn)

mats_prob%>%
  na.omit()%>%
  ggplot()+
    geom_sf(data=ty$geometry, fill=NA)+
  geom_raster(mapping=aes(x=x,y=y,fill=layer/1000))+
    scale_fill_gradientn(colours=c("darkgreen","yellow","red"))+
  theme(panel.background=element_rect(color="black",fill=NA),
        legend.title=element_blank())+
  labs(x="longitude", y="lattitude")+
  scalebar(x.min = 163.30, x.max = 163.36,
           y.min = -77.64, y.max = -77.65,
           dist = 1, dist_unit = "km", st.color = "black",
           transform = TRUE, model = "WGS84", st.size=2, height=0.05, st.dist=0.1, border.size=0.2)+
  annotation_north_arrow(location = "tl", which_north = "true", 
                         pad_x = unit(0.02, "in"), pad_y = unit(0.1, "in"),
                         height=unit(0.8, "cm"),
                         style = north_arrow_fancy_orienteering)




# ggsave("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/figure_output/Ensemble_plot_final.jpeg",
#        width=6,height=5, units="in", dpi=500)

```

## calculation of area suitable for the blackmat distribution

```{r}
mats_pro<-raster("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/code/blackmat/proj_Current/individual_projections/blackmat_EMmeanByTSS_mergedAlgo_mergedRun_mergedData.gri")/1000


mats_pro[is.na(mats_pro[])]<-99

g<-as.data.frame(mats_pro,xy=TRUE)


ty<-read_sf("C:/Users/Khum/Documents/mbm_updated_data/fryxell_basin/Fryxell_basin_modified.shp")%>%
  st_transform(crs(mats_pro))%>%
  st_zm()
## 
st_area(ty) # for the area calculation

mats_masked<-mask(mats_pro,ty)>0.50

mats_pro_g50p<-mats_pro>0.50

# mats_av<-mats_pro/1000
# 
# mats_totol<-mats_av>=0

mats_area<-as.data.frame(mats_pro_g50p,xy=TRUE)

g<-as.data.frame(mats_masked,xy=TRUE)


```

## Two raster calcualtiond and comparisions

```{r}

# blackmat raster layers
blk_mat <- raster("C:/Users/Khum/Documents/mbm_updated_data/response/PERCENTAGE_black-mat.tif")

mats_sdm<-raster("C:/Users/Khum/OneDrive - UCB-O365/Mats_sdm/code/blackmat/proj_Current/individual_projections/blackmat_EMmeanByTSS_mergedAlgo_mergedRun_mergedData.gri")

mats_sdm_pr<-projectRaster(mats_sdm,blk_mat)

# masking unmixming using sdm
blk_mat_msk<-mask(blk_mat,mats_sdm_pr)



mats_sdm_pr_d<-mats_sdm_pr>500

mats_sdm_pr_d[mats_sdm_pr_d==1]<-2

blk_mat_msk_d<-blk_mat_msk>0.05

diff<- mats_sdm_pr_d-blk_mat_msk_d

diff.tb<-as.data.frame(diff,xy=TRUE)

diff1<-blk_mat_msk_d-mats_sdm_pr_d

m<-as.data.frame(diff1,xy=TRUE)

```



```{r}
list_pre <-list.files("C:/Users/Khum/Box/MBM shared drive/Data/Data for Khum/derived_variables/Unmix_Snow", pattern=".tif$", full.names=TRUE)

list_pre1 <-list.files("C:/Users/Khum/Box/MBM shared drive/Data/Data for Khum/derived_variables/Unmix_Black-Mat", pattern=".tif$", full.names=TRUE)



```











```{r}

sdm<-raster("C:/Users/Khum/Downloads/New Data (from Salvatore, 09-12-2023)/blk_sdm_reproj.tif")

unmix<-raster("C:/Users/Khum/Downloads/New Data (from Salvatore, 09-12-2023)/blk_unmix_reproj.tif")


sdm1<-projectRaster(sdm,unmix)

sdm2<-sdm1>=500

sdm2[sdm2==1]<-2

unmix1<-mask(unmix,sdm1)
unmix2<-unmix1>=0.05

diff<-sdm2-unmix2

diff.df<-as.data.frame(diff,xy=TRUE)

```






















